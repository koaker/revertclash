<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/revertclash.css">
    <link rel="stylesheet" href="/css/modern-theme.css">
    <style>
        body {
            font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--light-gray);
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 1rem;
        }
        .table th, .table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        /* 设置列宽度 */
        .table th:nth-child(1),
        .table td:nth-child(1) {
            width: 180px;
            min-width: 180px;
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table th:nth-child(2),
        .table td:nth-child(2) {
            min-width: 300px;
        }
        .table th:nth-child(3),
        .table td:nth-child(3) {
            width: 150px;
            min-width: 150px;
        }
        /* URL单元格样式 */
        .table td.url-cell {
            max-width: 500px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
            padding-right: 20px; /* 防止文字贴近右边界 */
        }
        /* URL hover效果 */
        .table td.url-cell:hover::after {
            content: attr(title);
            position: absolute;
            left: 0;
            top: 100%;
            z-index: 1000;
            background: white;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: max-content;
            max-width: 800px;
            word-break: break-all;
            white-space: normal;
        }
        .table th {
            background-color: #f8f9fa;
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            background-color: #007bff;
            color: white;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            width: 50%;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: .5rem;
        }
        .form-control {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        textarea.form-control {
            min-height: 200px;
            font-family: monospace;
        }
        .close {
            float: right;
            cursor: pointer;
            font-size: 1.5rem;
        }
        .alert {
            padding: 10px;
            margin-bottom: 1rem;
            border-radius: 4px;
            display: none;
        }
        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .upload-area-config {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area-config:hover {
            border-color: var(--primary-color);
            background-color: #e9f0ff;
        }
        
        .upload-area-config.dragover {
            border-color: var(--primary-color);
            background-color: #e9f0ff;
        }
    </style>
</head>
<body>
    <!-- 导航栏容器 -->
    <div id="navbar-container" data-rc-navbar-auto-init="true"></div>

    <div class="rc-content">
    <div class="rc-container">
        <!-- 提示框 -->
        <div id="alert" class="rc-alert"></div>

        <!-- 顶部操作栏 -->
        <div class="rc-card" style="margin-bottom: 20px;">
            <div class="rc-card-body">
                <div class="rc-d-flex rc-justify-between rc-align-center">
                    <div>
                        <button class="rc-btn rc-btn-primary" onclick="updateConfig()" style="font-size: 16px; padding: 10px 20px;">
                            <span id="updateBtnText">立即更新配置</span>
                            <span id="updateSpinner" style="display: none;">更新中...</span>
                        </button>
                        <button class="rc-btn rc-btn-outline-primary rc-ml-2" onclick="window.open('/cache-management.html', '_blank')" style="margin-left: 10px;">
                            <i class="bi bi-database me-1"></i>
                            缓存管理
                        </button>
                    </div>
                    <div id="cacheOverview" style="font-size: 0.9em; color: #666;">
                        <!-- 缓存概览信息将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- URL管理部分 -->
        <div class="rc-card">
            <div class="rc-card-header">
                <i class="bi bi-link me-2"></i>
                URL管理
            </div>
            <div class="rc-card-body">
                <button class="rc-btn rc-btn-primary rc-mb-3" onclick="showAddUrlModal()">
                    <i class="bi bi-plus-circle me-1"></i>
                    添加URL
                </button>
                <div class="table-responsive">
                    <table class="table" id="urlTable">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>URL</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 配置文件管理部分 -->
        <div class="rc-card rc-mt-4">
            <div class="rc-card-header">
                <i class="bi bi-file-code me-2"></i>
                配置文件管理
            </div>
            <div class="rc-card-body">
                <div class="rc-mb-3">
                    <button class="rc-btn rc-btn-primary me-2" onclick="showAddConfigModal()">
                        <i class="bi bi-plus-circle me-1"></i>
                        添加配置
                    </button>
                    <button class="rc-btn rc-btn-outline-primary me-2" onclick="showUploadConfigFileModal()">
                        <i class="bi bi-cloud-upload me-1"></i>
                        上传配置文件
                    </button>
                    <button class="rc-btn rc-btn-outline-warning" onclick="showDebugModal()">
                        <i class="bi bi-bug me-1"></i>
                        调试订阅
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table" id="configTable">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>大小</th>
                                <th>修改时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 协议转换部分 -->
        <div class="rc-card rc-mt-4" id="protocol-converter">
            <div class="rc-card-header">
                <i class="bi bi-arrow-repeat me-2"></i>
                协议转换
            </div>
            <div class="rc-card-body">
                <p>在不同协议之间转换，支持SS、VLESS和Hysteria2等协议。</p>
                
                <div class="rc-card rc-mb-4">
                    <div class="rc-card-header">
                        <h5 class="rc-mb-0">导入非Clash订阅链接</h5>
                    </div>
                    <div class="rc-card-body">
                        <button class="rc-btn rc-btn-primary rc-mb-3" onclick="showImportNonClashModal()">
                            <i class="bi bi-plus-circle"></i> 导入非Clash链接
                        </button>
                        
                        <div class="rc-alert rc-alert-info">
                            <i class="bi bi-info-circle"></i> 您可以将非Clash格式的订阅链接转换为Clash配置文件并保存。
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- URL模态框 -->
        <div id="urlModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeUrlModal()">&times;</span>
                <h3>URL配置</h3>
                <form id="urlForm">
                    <input type="hidden" id="urlOldName">
                    <div class="rc-form-group">
                        <label for="urlName" class="rc-form-label">名称</label>
                        <input type="text" id="urlName" class="rc-form-control" required>
                    </div>
                    <div class="rc-form-group">
                        <label for="urlValue" class="rc-form-label">URL</label>
                        <input type="text" id="urlValue" class="rc-form-control" required>
                    </div>
                    <button type="submit" class="rc-btn rc-btn-primary">保存</button>
                </form>
            </div>
        </div>

        <!-- 配置文件模态框 -->
        <div id="configModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeConfigModal()">&times;</span>
                <h3>配置文件</h3>
                <form id="configForm">
                    <div class="rc-form-group">
                        <label for="configName" class="rc-form-label">文件名 (.yaml)</label>
                        <input type="text" id="configName" class="rc-form-control" required>
                        <input type="hidden" id="configOldName" value="">
                    </div>
                    <div class="rc-form-group">
                        <label for="configContent" class="rc-form-label">内容</label>
                        <textarea id="configContent" class="rc-form-control" required style="min-height: 200px; font-family: monospace;"></textarea>
                    </div>
                    <button type="submit" class="rc-btn rc-btn-primary">保存</button>
                </form>
            </div>
        </div>

        <!-- 导入非Clash链接模态框 -->
        <div id="importNonClashModal" class="modal">
            <div class="modal-content" style="width: 80%; max-width: 1200px;">
                <span class="close" onclick="closeImportNonClashModal()">&times;</span>
                <h3>导入非Clash订阅链接</h3>
                <div class="rc-form-group">
                    <label for="nonClashConfigName" class="rc-form-label">配置文件名称</label>
                    <input type="text" id="nonClashConfigName" class="rc-form-control" required placeholder="输入配置文件名称（不需要添加.yaml后缀）">
                </div>
                <div style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
                    <!-- 左侧：订阅链接输入 -->
                    <div style="flex: 1; min-width: 300px;">
                        <div class="rc-form-group">
                            <label for="nonClashLinks" class="rc-form-label">订阅链接</label>
                            <textarea id="nonClashLinks" class="rc-form-control" style="height: 300px;" placeholder="输入非Clash格式的订阅链接，每行一个，支持SS、VLESS、Hysteria2等协议"></textarea>
                        </div>
                        <button type="button" id="convertBtn" class="rc-btn rc-btn-primary" style="margin-top: 10px;">转换</button>
                    </div>
                    
                    <!-- 右侧：预览结果 -->
                    <div style="flex: 1; min-width: 300px;">
                        <div class="rc-form-group">
                            <label for="previewResult" class="rc-form-label">预览结果 (可编辑)</label>
                            <textarea id="previewResult" class="rc-form-control" style="height: 300px; font-family: monospace;"></textarea>
                        </div>
                        <button type="button" id="saveConfigBtn" class="rc-btn rc-btn-primary" style="margin-top: 10px; float: right;">保存为配置文件</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 上传配置文件模态框 -->
        <div id="uploadConfigFileModal" class="modal">
            <div class="modal-content" style="width: 70%; max-width: 800px;">
                <span class="close" onclick="closeUploadConfigFileModal()">&times;</span>
                <h3><i class="bi bi-cloud-upload me-2"></i>上传配置文件</h3>
                
                <div class="rc-form-group">
                    <label for="uploadConfigFileName" class="rc-form-label">配置文件名称</label>
                    <input type="text" id="uploadConfigFileName" class="rc-form-control" required 
                           placeholder="输入文件名称（不需要添加.yaml后缀）">
                </div>
                
                <div class="rc-form-group">
                    <label class="rc-form-label">选择配置文件</label>
                    <div class="upload-area-config" onclick="document.getElementById('uploadConfigFileInput').click()">
                        <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
                        <p class="mb-2">点击选择文件或拖拽 YAML/YML 文件到此处</p>
                        <p class="small text-muted">支持 .yaml, .yml 格式，最大5MB</p>
                        <input type="file" id="uploadConfigFileInput" accept=".yaml,.yml" style="display: none;" onchange="handleConfigFileSelect(this)">
                    </div>
                </div>
                
                <div class="rc-form-group">
                    <label for="uploadConfigFileContent" class="rc-form-label">
                        配置内容预览
                        <small class="text-muted">（可编辑）</small>
                    </label>
                    <textarea id="uploadConfigFileContent" class="rc-form-control" 
                              style="min-height: 250px; font-family: monospace;" required
                              placeholder="配置文件内容将在此显示，也可直接粘贴内容..."></textarea>
                </div>
                
                <div id="configFileValidationResults" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <strong>配置验证结果：</strong>
                        <div id="configFileValidationDetails"></div>
                    </div>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="rc-btn rc-btn-secondary me-2" onclick="closeUploadConfigFileModal()">取消</button>
                    <button type="button" class="rc-btn rc-btn-outline-primary me-2" onclick="validateConfigFile()">
                        <i class="bi bi-check-circle me-1"></i>验证配置
                    </button>
                    <button type="button" class="rc-btn rc-btn-primary" onclick="uploadConfigFile()">
                        <i class="bi bi-upload me-1"></i>上传配置
                    </button>
                </div>
            </div>
        </div>

        <!-- 调试模态框 -->
        <div id="debugModal" class="modal">
            <div class="modal-content" style="width: 80%; max-width: 1000px;">
                <span class="close" onclick="closeDebugModal()">&times;</span>
                <h3><i class="bi bi-bug me-2"></i>订阅调试工具</h3>
                
                <div class="rc-form-group">
                    <label for="debugSubscriptionName" class="rc-form-label">订阅名称</label>
                    <input type="text" id="debugSubscriptionName" class="rc-form-control" 
                           placeholder="输入要调试的订阅名称（如：ICMP）">
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button type="button" class="rc-btn rc-btn-primary" onclick="runDebugCheck()">
                        <i class="bi bi-search me-1"></i>开始调试检查
                    </button>
                </div>
                
                <div id="debugResults" style="display: none;">
                    <h4>调试结果：</h4>
                    <div id="debugContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 400px; overflow-y: auto;">
                        <!-- 调试结果将在此显示 -->
                    </div>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="rc-btn rc-btn-secondary" onclick="closeDebugModal()">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/navbar.js"></script>
    <script>
        // 更新配置函数
        async function updateConfig() {
            const btnText = document.getElementById('updateBtnText');
            const spinner = document.getElementById('updateSpinner');
            const btn = spinner.parentElement;
            
            try {
                // 禁用按钮
                btn.disabled = true;
                btnText.style.display = 'none';
                spinner.style.display = 'inline';
                
                const response = await fetch('/api/update', {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || '更新失败');
                }
                
                showAlert(data.message, 'success');
                
                // 刷新列表
                await Promise.all([loadUrls(), loadConfigs(), loadCacheOverview()]);
            } catch (err) {
                showAlert(err.message);
            } finally {
                // 恢复按钮状态
                btn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        // 加载缓存概览信息
        async function loadCacheOverview() {
            try {
                const response = await fetch('/api/configs/cache/stats');
                if (!response.ok) return; // 静默失败
                
                const data = await response.json();
                if (data.status === 'success') {
                    const stats = data.data;
                    const overview = document.getElementById('cacheOverview');
                    overview.innerHTML = `
                        <i class="bi bi-database me-1"></i>
                        缓存状态: ${stats.cachedSubscriptions}/${stats.totalSubscriptions} 已缓存
                        <span style="color: #28a745; margin-left: 8px;">✓ ${stats.totalSuccessCount}</span>
                        <span style="color: #dc3545; margin-left: 4px;">✗ ${stats.totalFailureCount}</span>
                    `;
                }
            } catch (err) {
                // 静默处理错误，不影响主要功能
                console.log('加载缓存概览失败:', err);
            }
        }

        // 全局变量
        let isEditing = false;

        // 工具函数
        function showAlert(message, type = 'danger') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `rc-alert rc-alert-${type}`;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        }

        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }

// 格式化流量使用情况
function formatDataUsage(download, upload, total) {
    // 检查 download 和 upload 是否为有效数字
    if (typeof download !== 'number' || typeof upload !== 'number') {
        return '流量信息不完整'; // 或者返回空字符串，如果不希望显示不完整信息
    }
    const gb = 1024 * 1024 * 1024;
    const tb = gb * 1024;
    const format = (bytes) => {
        if (bytes === 0) return '0 B'; // 显示 0 B 而不是 0 GB
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        if (bytes < gb) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        if (bytes < tb) return (bytes / gb).toFixed(2) + ' GB';
        return (bytes / tb).toFixed(2) + ' TB';
    };
    const used = download + upload;

    // 检查是否为无限流量 (total 为 0 或非数字)
    if (typeof total !== 'number' || total === 0) {
        return `已用: ${format(used)} / 无限`;
    }

    // 计算百分比
    const percentage = ((used / total) * 100).toFixed(1);
    return `已用: ${format(used)} / ${format(total)} (${percentage}%)`;
}

        // 格式化过期时间
        function formatExpireDate(timestamp) {
            if (typeof timestamp !== 'number' || timestamp <= 0) {
                return '过期时间未知';
            }
            // Unix 时间戳通常是秒，需要乘以 1000 转换为毫秒
            const date = new Date(timestamp * 1000);
            // 检查日期是否有效
             if (isNaN(date.getTime())) {
                return '过期时间无效';
            }
            // 判断是否已过期
            const now = new Date();
            const isExpired = date < now;
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            return `过期时间: ${formattedDate}${isExpired ? ' (已过期)' : ''}`;
        }
        // URL管理功能
        async function loadUrls() {
            try {
                // 并行加载URL列表和缓存状态
                const [urlResponse, cacheResponse] = await Promise.all([
                    fetch('/api/urls'),
                    fetch('/api/configs/cache/list?include_expired=true').catch(() => ({ ok: false }))
                ]);
                
                if (!urlResponse.ok) throw new Error('加载URL失败');
                const urls = await urlResponse.json();
                
                // 获取缓存状态映射
                let cacheMap = new Map();
                if (cacheResponse.ok) {
                    const cacheData = await cacheResponse.json();
                    if (cacheData.status === 'success') {
                        cacheData.data.forEach(cache => {
                            cacheMap.set(cache.subscriptionName, cache);
                        });
                    }
                }
                
                const tbody = document.querySelector('#urlTable tbody');
                tbody.innerHTML = '';

                urls.forEach(urlItem => { // 修改变量名以包含 userInfo
                    const { name, url, userInfo } = urlItem; // 解构获取 userInfo
                    const tr = document.createElement('tr');

                    // 构建用户信息 HTML 字符串
                    let userInfoHtml = '';
                    if (userInfo) {
                        const usageInfo = formatDataUsage(userInfo.download, userInfo.upload, userInfo.total);
                        const expireInfo = formatExpireDate(userInfo.expire);
                        userInfoHtml = `
                            <div style="font-size: 0.8em; color: #666; margin-top: 4px;">
                                <span>${usageInfo}</span> | <span>${expireInfo}</span>
                            </div>
                        `;
                    }

                    // 构建缓存状态信息
                    let cacheStatusHtml = '';
                    const cacheInfo = cacheMap.get(name);
                    if (cacheInfo) {
                        let statusColor, statusText;
                        if (!cacheInfo.hasContent) {
                            statusColor = '#dc3545'; // 红色
                            statusText = '无缓存';
                        } else if (cacheInfo.isExpired) {
                            statusColor = '#ffc107'; // 黄色
                            statusText = '缓存过期';
                        } else {
                            statusColor = '#28a745'; // 绿色
                            statusText = '缓存正常';
                        }
                        
                        cacheStatusHtml = `
                            <div style="font-size: 0.7em; margin-top: 4px;">
                                <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: ${statusColor}; margin-right: 4px;"></span>
                                <span style="color: ${statusColor};">${statusText}</span>
                                <span style="color: #999; margin-left: 8px;">成功: ${cacheInfo.fetchSuccessCount || 0} | 失败: ${cacheInfo.fetchFailureCount || 0}</span>
                            </div>
                        `;
                    }

                    tr.innerHTML = `
                        <td style="width: 180px; min-width: 180px; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</td>
                        <td class="url-cell" title="${url}">
                            ${url}
                            ${userInfoHtml}
                            ${cacheStatusHtml}
                        </td>
                        <td style="width: 150px; min-width: 150px;">
                            <button class="btn" onclick="editUrl('${name}', '${url}')">编辑</button>
                            <button class="btn btn-danger" onclick="deleteUrl('${name}')">删除</button>
                            ${cacheInfo ? `<button class="btn" style="background-color: #17a2b8; color: white; font-size: 12px; padding: 2px 6px; margin-top: 2px;" onclick="window.open('/cache-management.html', '_blank')" title="查看缓存详情">缓存</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                showAlert(err.message);
            }
        }

        function showAddUrlModal() {
            isEditing = false;
            document.getElementById('urlForm').reset();
            document.getElementById('urlModal').style.display = 'block';
        }

        function closeUrlModal() {
            document.getElementById('urlModal').style.display = 'none';
        }

        function editUrl(name, url) {
            isEditing = true;
            document.getElementById('urlOldName').value = name;
            document.getElementById('urlName').value = name;
            document.getElementById('urlValue').value = url;
            document.getElementById('urlModal').style.display = 'block';
        }

        async function deleteUrl(name) {
            if (!confirm(`确定要删除 ${name} 吗？`)) return;
            
            try {
                const response = await fetch(`/api/urls/${name}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('删除失败');
                showAlert('删除成功', 'success');
                await loadUrls();
            } catch (err) {
                showAlert(err.message);
            }
        }

        document.getElementById('urlForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('urlName').value;
            const url = document.getElementById('urlValue').value;
            const oldName = document.getElementById('urlOldName').value;

            try {
                const response = await fetch(isEditing ? `/api/urls/${oldName}` : '/api/urls', {
                    method: isEditing ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, url })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || '操作失败');
                }

                showAlert('保存成功', 'success');
                closeUrlModal();
                await loadUrls();
            } catch (err) {
                showAlert(err.message);
            }
        };

        // 配置文件管理功能
        async function loadConfigs() {
            try {
                const response = await fetch('/api/configs');
                if (!response.ok) throw new Error('加载配置失败');
                const configs = await response.json();
                
                const tbody = document.querySelector('#configTable tbody');
                tbody.innerHTML = '';
                
                configs.forEach(({name, size, modifiedTime}) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${name}</td>
                        <td>${formatSize(size)}</td>
                        <td>${formatDate(modifiedTime)}</td>
                        <td>
                            <button class="btn" onclick="editConfig('${name}')">编辑</button>
                            <button class="btn btn-danger" onclick="deleteConfig('${name}')">删除</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                showAlert(err.message);
            }
        }

        // 配置文件表单处理
        let isConfigEditing = false;

        function showAddConfigModal() {
            isConfigEditing = false;
            const configNameInput = document.getElementById('configName');
            document.getElementById('configForm').reset();
            configNameInput.readOnly = false;
            document.getElementById('configModal').style.display = 'block';
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
        }

        async function editConfig(name) {
            try {
                const response = await fetch(`/api/configs/${name}`);
                if (!response.ok) throw new Error('加载配置失败');
                const {content} = await response.json();
                
                isConfigEditing = true;
                const configNameInput = document.getElementById('configName');
                configNameInput.value = name;
                // 允许编辑文件名，删除readOnly属性
                document.getElementById('configOldName').value = name; // 保存原始文件名
                document.getElementById('configContent').value = content;
                document.getElementById('configModal').style.display = 'block';
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function deleteConfig(name) {
            if (!confirm(`确定要删除 ${name} 吗？`)) return;
            
            try {
                const response = await fetch(`/api/configs/${name}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('删除失败');
                showAlert('删除成功', 'success');
                await loadConfigs();
            } catch (err) {
                showAlert(err.message);
            }
        }

        document.getElementById('configForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('configName').value;
            const oldName = document.getElementById('configOldName').value;
            const content = document.getElementById('configContent').value;

            try {
                // 判断是否需要重命名
                const isRenaming = isConfigEditing && name !== oldName;
                
                // 如果是编辑模式且文件名发生变化，使用原始名称作为路径
                const url = isConfigEditing ? `/api/configs/${oldName}` : '/api/configs';
                
                const response = await fetch(url, {
                    method: isConfigEditing ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // 新增重命名字段
                    body: JSON.stringify(isConfigEditing ? 
                        (isRenaming ? { content, newName: name } : { content }) : 
                        { name, content })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || '保存失败');
                }

                showAlert(isRenaming ? '配置文件重命名成功' : '保存成功', 'success');
                closeConfigModal();
                await loadConfigs();
            } catch (err) {
                showAlert(err.message);
            }
        };

        // 协议转换相关功能
        function showImportNonClashModal() {
            // 清空输入框
            document.getElementById('nonClashConfigName').value = '';
            document.getElementById('nonClashLinks').value = '';
            document.getElementById('previewResult').value = '';
            document.getElementById('importNonClashModal').style.display = 'block';
        }
        
        function closeImportNonClashModal() {
            document.getElementById('importNonClashModal').style.display = 'none';
        }
        
        // 单个URI转换相关功能已移除
        
        // 转换按钮点击事件
        document.getElementById('convertBtn').addEventListener('click', async () => {
            const links = document.getElementById('nonClashLinks').value.trim();
            
            if (!links) {
                showAlert('订阅链接不能为空');
                return;
            }
            
            try {
                // 将多行链接拆分为数组
                const uriList = links.split('\n').filter(uri => uri.trim());
                
                const response = await fetch('/api/converter/batch-convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: uriList,
                        format: 'yaml'
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || '转换失败');
                }
                
                // 检查转换结果
                if (!result.successful || result.successful.length === 0) {
                    throw new Error('没有成功转换的URI');
                }
                
                // 收集所有成功转换的节点
                const allProxies = [];
                
                for (const item of result.successful) {
                    const config = item.config;
                    if (typeof config === 'object') {
                        // 如果是对象格式，直接添加
                        allProxies.push(config);
                    } else if (typeof config === 'string') {
                        // 如果是字符串格式，尝试解析
                        try {
                            const YAML = await import('https://cdn.jsdelivr.net/npm/yaml@2.3.1/+esm');
                            const parsedConfig = YAML.parse(config);
                            if (parsedConfig) {
                                allProxies.push(parsedConfig);
                            }
                        } catch (err) {
                            console.error('解析配置失败:', err);
                            // 如果解析失败，尝试直接添加字符串
                            allProxies.push({ name: `节点${allProxies.length + 1}`, config });
                        }
                    }
                }
                
                // 生成包含所有节点的完整配置对象
                const completeConfig = {
                    proxies: allProxies
                };
                
                // 将完整配置转换为YAML字符串
                let configContent;
                try {
                    const YAML = await import('https://cdn.jsdelivr.net/npm/yaml@2.3.1/+esm');
                    configContent = YAML.stringify(completeConfig);
                } catch (err) {
                    console.error('转换YAML失败:', err);
                    // Fallback logic refinement - Manual YAML generation
                    configContent = 'proxies:\n';
                    for (const proxy of allProxies) {
                        // Convert proxy object to YAML string individually with proper indentation
                        let proxyYamlLines = [];
                        const keys = Object.keys(proxy);

                        // Helper function for basic YAML value formatting
                        const formatYamlValue = (value) => {
                            if (typeof value === 'string') {
                                // Basic check for multiline or special chars, quote if needed
                                if (value.includes('\n') || value.includes(': ') || value.includes('#')) {
                                     // Use literal block scalar for multiline strings
                                     if (value.includes('\n')) {
                                         // Indent lines correctly for literal block scalar
                                         return '|\n' + value.split('\n').map(l => `      ${l}`).join('\n');
                                     } else {
                                         // Quote simple strings containing special characters
                                         return JSON.stringify(value);
                                     }
                                }
                                return value; // Return as is if no special handling needed
                            } else if (typeof value === 'object' && value !== null) {
                                // Simple approach for nested objects: convert to JSON string
                                // A proper recursive YAML formatter would be more robust but complex here
                                // We need to indent the JSON string correctly
                                const jsonStr = JSON.stringify(value, null, 2); // Pretty print JSON
                                const jsonLines = jsonStr.split('\n');
                                // Indent each line of the JSON string
                                return '\n' + jsonLines.map(l => `      ${l}`).join('\n');
                            }
                            return value; // Numbers, booleans returned as is
                        };

                        keys.forEach((key, keyIndex) => {
                            const value = proxy[key];
                            const formattedValue = formatYamlValue(value);
                            const indent = keyIndex === 0 ? '  - ' : '    '; // First key starts the list item

                            // Handle multiline or complex values correctly
                            if (typeof formattedValue === 'string' && (formattedValue.startsWith('|\n') || formattedValue.startsWith('\n'))) {
                                proxyYamlLines.push(`${indent}${key}: ${formattedValue}`);
                            } else {
                                proxyYamlLines.push(`${indent}${key}: ${formattedValue}`);
                            }
                        });
                         configContent += proxyYamlLines.join('\n') + '\n';
                    }
                }

                // 显示在预览区域
                document.getElementById('previewResult').value = configContent;
                
                showAlert('转换成功，请在右侧预览结果', 'success');
            } catch (err) {
                showAlert(err.message);
            }
        });
        
        // 保存按钮点击事件
        document.getElementById('saveConfigBtn').addEventListener('click', async () => {
            const name = document.getElementById('nonClashConfigName').value.trim();
            const content = document.getElementById('previewResult').value.trim();
            
            if (!name) {
                showAlert('配置文件名称不能为空');
                return;
            }
            
            if (!content) {
                showAlert('预览结果不能为空，请先转换订阅链接');
                return;
            }
            
            try {
                // 保存配置
                const saveResponse = await fetch('/api/configs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name.endsWith('.yaml') ? name : name + '.yaml',
                        content: content
                    })
                });
                
                if (!saveResponse.ok) {
                    const error = await saveResponse.json();
                    throw new Error(error.error || '保存失败');
                }
                
                showAlert('配置文件保存成功', 'success');
                closeImportNonClashModal();
                await loadConfigs();
            } catch (err) {
                showAlert(err.message);
            }
        });

        // 配置文件上传功能
        function showUploadConfigFileModal() {
            document.getElementById('uploadConfigFileName').value = '';
            document.getElementById('uploadConfigFileContent').value = '';
            document.getElementById('configFileValidationResults').style.display = 'none';
            setupConfigFileUploadDragDrop();
            document.getElementById('uploadConfigFileModal').style.display = 'block';
        }

        function closeUploadConfigFileModal() {
            document.getElementById('uploadConfigFileModal').style.display = 'none';
        }

        // 设置配置文件拖拽上传
        function setupConfigFileUploadDragDrop() {
            const uploadArea = document.querySelector('.upload-area-config');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleConfigFileSelect({ files });
                }
            });
        }

        // 处理配置文件选择
        function handleConfigFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            
            // 检查文件大小 (限制为5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showAlert('文件大小不能超过5MB');
                return;
            }
            
            // 检查文件类型
            const allowedTypes = ['.yaml', '.yml'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            if (!allowedTypes.includes(fileExtension)) {
                showAlert('只支持 .yaml 和 .yml 格式的文件');
                return;
            }
            
            // 自动填充文件名（去掉扩展名）
            const fileName = file.name.replace(/\.(yaml|yml)$/i, '');
            document.getElementById('uploadConfigFileName').value = fileName;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('uploadConfigFileContent').value = e.target.result;
                showAlert('文件读取成功，请验证配置内容', 'success');
            };
            reader.onerror = function() {
                showAlert('文件读取失败，请重试');
            };
            reader.readAsText(file);
        }

        // 验证配置文件
        function validateConfigFile() {
            const content = document.getElementById('uploadConfigFileContent').value.trim();
            
            if (!content) {
                showAlert('请输入配置内容');
                return;
            }
            
            const validationResults = document.getElementById('configFileValidationResults');
            const validationDetails = document.getElementById('configFileValidationDetails');
            
            try {
                // 基础YAML格式验证
                let yamlData;
                try {
                    yamlData = parseYAMLForConfig(content);
                } catch (parseErr) {
                    throw new Error('YAML格式错误: ' + parseErr.message);
                }
                
                // 验证是否为有效的Clash配置
                const validationResult = validateClashConfig(yamlData);
                
                let resultHtml = `
                    <div class="mb-2">
                        <span class="badge bg-${validationResult.isValid ? 'success' : 'warning'}">${validationResult.isValid ? '配置有效' : '配置有问题'}</span>
                        ${validationResult.proxiesCount > 0 ? `<span class="badge bg-info ms-2">${validationResult.proxiesCount} 个代理节点</span>` : ''}
                        ${validationResult.rulesCount > 0 ? `<span class="badge bg-info ms-2">${validationResult.rulesCount} 条规则</span>` : ''}
                    </div>
                `;
                
                if (validationResult.warnings.length > 0) {
                    resultHtml += `
                        <div class="mt-2">
                            <strong>注意事项：</strong>
                            <ul class="mb-0 mt-1">
                                ${validationResult.warnings.slice(0, 5).map(warning => `<li>${warning}</li>`).join('')}
                                ${validationResult.warnings.length > 5 ? `<li>还有 ${validationResult.warnings.length - 5} 个其他提示...</li>` : ''}
                            </ul>
                        </div>
                    `;
                }
                
                validationDetails.innerHTML = resultHtml;
                validationResults.style.display = 'block';
                
                if (validationResult.isValid) {
                    showAlert('配置验证通过', 'success');
                } else {
                    showAlert('配置验证有警告，请检查', 'warning');
                }
                
            } catch (err) {
                validationDetails.innerHTML = `<div class="text-danger">${err.message}</div>`;
                validationResults.style.display = 'block';
                showAlert('配置验证失败: ' + err.message);
            }
        }

        // 解析YAML配置（更全面的解析）
        function parseYAMLForConfig(yamlStr) {
            const lines = yamlStr.split('\n');
            const result = {};
            let currentSection = null;
            let currentArray = null;
            let currentItem = null;
            
            for (let line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) continue;
                
                // 检测主要部分
                if (trimmed.match(/^(port|socks-port|allow-lan|mode|log-level|external-controller):/)) {
                    const [key, value] = trimmed.split(':').map(s => s.trim());
                    result[key] = isNaN(value) ? value.replace(/['"]/g, '') : parseInt(value);
                    continue;
                }
                
                // 检测数组开始
                if (trimmed.match(/^(proxies|proxy-groups|rules):/)) {
                    const section = trimmed.replace(':', '');
                    result[section] = [];
                    currentArray = result[section];
                    currentSection = section;
                    continue;
                }
                
                // 检测数组项
                if (trimmed.startsWith('- ') && currentArray) {
                    if (currentSection === 'rules') {
                        // 规则是简单字符串
                        currentArray.push(trimmed.substring(2).trim());
                    } else {
                        // 代理和代理组是对象
                        currentItem = {};
                        currentArray.push(currentItem);
                        
                        const firstField = trimmed.substring(2).trim();
                        if (firstField.includes(':')) {
                            const [key, value] = firstField.split(':').map(s => s.trim());
                            currentItem[key] = value.replace(/['"]/g, '');
                        }
                    }
                    continue;
                }
                
                // 解析对象字段
                if (trimmed.includes(':') && currentItem && currentSection !== 'rules') {
                    const [key, value] = trimmed.split(':').map(s => s.trim());
                    if (key && value) {
                        if (/^\d+$/.test(value)) {
                            currentItem[key] = parseInt(value);
                        } else if (value.startsWith('[') && value.endsWith(']')) {
                            // 处理数组
                            try {
                                currentItem[key] = JSON.parse(value);
                            } catch {
                                currentItem[key] = value.replace(/['"]/g, '');
                            }
                        } else {
                            currentItem[key] = value.replace(/['"]/g, '');
                        }
                    }
                }
            }
            
            return result;
        }

        // 验证Clash配置
        function validateClashConfig(config) {
            const result = {
                isValid: true,
                warnings: [],
                proxiesCount: 0,
                rulesCount: 0
            };
            
            // 检查基础字段
            if (!config.port && !config['socks-port']) {
                result.warnings.push('建议设置port或socks-port');
            }
            
            if (!config.mode) {
                result.warnings.push('建议设置mode (rule, global, direct)');
            }
            
            // 检查代理
            if (config.proxies && Array.isArray(config.proxies)) {
                result.proxiesCount = config.proxies.length;
                if (result.proxiesCount === 0) {
                    result.warnings.push('配置中没有代理节点');
                }
            } else {
                result.warnings.push('配置中缺少proxies部分');
            }
            
            // 检查代理组
            if (config['proxy-groups'] && Array.isArray(config['proxy-groups'])) {
                if (config['proxy-groups'].length === 0) {
                    result.warnings.push('建议设置proxy-groups代理组');
                }
            } else {
                result.warnings.push('配置中缺少proxy-groups部分');
            }
            
            // 检查规则
            if (config.rules && Array.isArray(config.rules)) {
                result.rulesCount = config.rules.length;
                if (result.rulesCount === 0) {
                    result.warnings.push('配置中没有规则');
                }
            } else {
                result.warnings.push('配置中缺少rules部分');
            }
            
            // 如果有太多严重问题，标记为无效
            if (result.warnings.length > 3 && result.proxiesCount === 0) {
                result.isValid = false;
            }
            
            return result;
        }

        // 上传配置文件
        async function uploadConfigFile() {
            const fileName = document.getElementById('uploadConfigFileName').value.trim();
            const content = document.getElementById('uploadConfigFileContent').value.trim();
            
            if (!fileName || !content) {
                showAlert('请填写完整的文件名和配置内容');
                return;
            }
            
            // 确保文件名有正确的扩展名
            const finalFileName = fileName.endsWith('.yaml') || fileName.endsWith('.yml') ? 
                                  fileName : fileName + '.yaml';
            
            try {
                const response = await fetch('/api/configs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: finalFileName,
                        content: content
                    })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || '上传失败');
                }
                
                showAlert('配置文件上传成功', 'success');
                closeUploadConfigFileModal();
                await loadConfigs();
            } catch (err) {
                console.error('上传配置文件失败:', err);
                showAlert('上传配置文件失败: ' + err.message);
            }
        }

        // 调试功能
        function showDebugModal() {
            document.getElementById('debugSubscriptionName').value = '';
            document.getElementById('debugResults').style.display = 'none';
            document.getElementById('debugModal').style.display = 'block';
        }

        function closeDebugModal() {
            document.getElementById('debugModal').style.display = 'none';
        }

        async function runDebugCheck() {
            const subscriptionName = document.getElementById('debugSubscriptionName').value.trim();
            
            if (!subscriptionName) {
                showAlert('请输入订阅名称');
                return;
            }
            
            try {
                const response = await fetch(`/api/configs/debug/${encodeURIComponent(subscriptionName)}`);
                if (!response.ok) {
                    throw new Error('调试请求失败');
                }
                
                const data = await response.json();
                if (data.status === 'success') {
                    displayDebugResults(data.data);
                } else {
                    throw new Error(data.error || '调试失败');
                }
            } catch (err) {
                console.error('调试检查失败:', err);
                showAlert('调试检查失败: ' + err.message);
            }
        }

        function displayDebugResults(debugInfo) {
            const resultsDiv = document.getElementById('debugResults');
            const contentDiv = document.getElementById('debugContent');
            
            let html = `<strong>订阅名称:</strong> ${debugInfo.subscriptionName}<br>`;
            html += `<strong>检查时间:</strong> ${debugInfo.timestamp}<br><br>`;
            
            // URL列表检查结果
            html += `<strong>📋 URL列表检查:</strong><br>`;
            if (debugInfo.urlList.error) {
                html += `❌ 错误: ${debugInfo.urlList.error}<br>`;
            } else if (debugInfo.urlList.found) {
                html += `✅ 在URL列表中找到<br>`;
                html += `   - 名称: ${debugInfo.urlList.name}<br>`;
                html += `   - URL: ${debugInfo.urlList.url}<br>`;
            } else {
                html += `⚠️ 不在URL列表中 (${debugInfo.urlList.message})<br>`;
            }
            html += '<br>';
            
            // 缓存检查结果
            html += `<strong>💾 缓存检查:</strong><br>`;
            if (debugInfo.cache.error) {
                html += `❌ 错误: ${debugInfo.cache.error}<br>`;
            } else if (debugInfo.cache.found) {
                html += `✅ 找到缓存<br>`;
                html += `   - 有内容: ${debugInfo.cache.hasContent ? '是' : '否'}<br>`;
                html += `   - 内容长度: ${debugInfo.cache.contentLength} 字符<br>`;
                html += `   - 最后更新: ${debugInfo.cache.lastUpdated || '未知'}<br>`;
                html += `   - 最后成功: ${debugInfo.cache.lastFetchSuccess || '从未'}<br>`;
                html += `   - 是否过期: ${debugInfo.cache.isExpired ? '是' : '否'}<br>`;
                html += `   - 成功次数: ${debugInfo.cache.fetchSuccessCount}<br>`;
                html += `   - 失败次数: ${debugInfo.cache.fetchFailureCount}<br>`;
                
                if (debugInfo.cache.parseResult) {
                    html += `   - 解析结果: ${debugInfo.cache.parseResult.success ? '✅ 成功' : '❌ 失败'}<br>`;
                    if (debugInfo.cache.parseResult.success) {
                        html += `   - 节点数量: ${debugInfo.cache.parseResult.proxyCount}<br>`;
                        if (debugInfo.cache.parseResult.sampleProxy) {
                            html += `   - 示例节点: ${debugInfo.cache.parseResult.sampleProxy}<br>`;
                        }
                    } else {
                        html += `   - 解析错误: ${debugInfo.cache.parseResult.error}<br>`;
                    }
                }
                
                if (debugInfo.cache.contentPreview) {
                    html += `<br><strong>内容预览:</strong><br>`;
                    html += `<div style="background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 3px; white-space: pre-wrap;">${debugInfo.cache.contentPreview}</div>`;
                }
            } else {
                html += `❌ 缓存不存在 (${debugInfo.cache.message})<br>`;
            }
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // 初始加载
        loadUrls();
        loadConfigs();
        loadCacheOverview();
    </script>
    </div>
</body>
</html>